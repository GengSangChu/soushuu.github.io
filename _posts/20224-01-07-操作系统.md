---
layout:     post
title:      操作系统
subtitle:   操作系统
date:       2024-01-07
author:     soushuuu
header-img: img/the-first.png
catalog: false
tags:
    - linux
---


#### 80X86保护模式及编程

- 系统寄存器和系统指令
    - 标志寄存器
    - 内存管理寄存器
        - 全局描述符表寄存器`GDTR`、局部描述符表寄存器`LDTR`、中断描述符表寄存器`IDTR`、任务寄存器`TR`，用于指定分段内存管理所使用的系统表的基地址
    - 控制寄存器
        - CR0、CR1、CR2、CR3
    - 系统指令
        - LLDT、LTR、STR...
- 保护模式内存管理
    - 内存寻址
    - 地址变换（虚拟地址到物理地址的变换）
        - 分段机制
            - 段定义
                - 段基址地址
                - 段限长
                - 段属性
            - 段描述符表
                - 全局描述符表GDT
                - 局部描述符表LDT
            - 段选择符（段选择子）
            - 段描述符
                - 代码和数据段描述符类型
                - 系统描述符类型
                    - 局部描述符表的段描述符
                    - 任务状态段描述符
                    - 调用门描述符
                    - 中断门描述符
                    - 陷阱门描述符
                    - 任务门描述符
        - 分页机制
            - 页表结构
            - 页表项格式
            - 虚拟存储
    - 保护
        - 段级保护
            - 段界限检查
            - 段类型检查
            - 特权级检查
                - 代码段之间转移控制时的特权级检查
                    - 直接调用或跳转到代码段
                    - 门描述符
                        - 调用门
                        - 陷阱门
                        - 中断门
                        - 任务门
                    - 堆栈切换
                    - 从被调用过程返回
            - 可寻址范围限制
            - 过程入口点限制
            - 指令集限制
        - 页级保护
        - 组合页级和段级保护
- 中断及异常处理
    - 异常和中断向量
        - 每个处理器定义的异常和中断条件都被赋予了一个标识号，称为向量（vector）。处理器把赋予异常或中断的向量用作中断描述符表IDT中的一个索引号，来定位一个异常或中断的处理程序入口点位置。
    - 中断源和异常源
        - 中断源
            - 硬中断
            - 软中断
        - 异常源
            - 处理器检测到的程序错误异常
            - 软件产生的异常
    - 异常分类
        - fault
        - trap
        - abort
    - 开中断、关中断
    - 异常和中断优先级
    - 中断描述符表IDT
        - 存放中断门描述符、陷阱门描述符、任务门描述符
    - 异常和中断处理
- 任务管理
    - 任务（Task）是处理器分配调度、执行、挂起的一个工作单元。可用于执行程序、任务或进程、操作系统服务、中断或异常处理过程、内核代码。
    - 任务结构和状态
        - 构成：任务执行空间（代码段、堆栈段、数据段）和任务状态段（task-state segment）
    - 任务执行
    - 任务管理数据结构

#### 操作系统

一个完整可用的操作系统由3部分组成：硬件、操作系统内核、操作系统服务、用户应用程序。

操作系统分为宏内核和微内核。

宏内核中，操作系统提供服务的流程为：应用主程序使用指定的参数值执行系统调用指令，使CPU从用户态切换到内核态，然后操作系统根据具体参数值调用特定的系统调用程序。完成应用程序所请求的服务后，操作系统又使CPU从内核态切换回用户态，从而返回到应用程序继续执行之后的指令。


#### linux目录结构

- arch：CPU体系相关通用代码，不同体系汇编不一样  （核心）
- boot：启动相关
- Documentation：内核文档
- init：内核启动相关代码  start_kernel 开始执行C代码，之前是汇编代码，进行内核初始化
- do_mounts*：挂载
- tools：工具
- blocks：块设备 （重要子系统）
- drivers：外设驱动 （驱动程序）
- ipc：进程通信相关 （重要子系统）
- security：安全相关 （周边子系统）
- net：网络子系统相关 （重要子系统）
- sound：声卡相关 （周边子系统）
- fs：文件系统相关 （重要子系统）
- kernel：内核核心相关通用代码，如进程调度、进程管理 （核心）
- include：内核头文件相关
- mm：内存管理相关 （核心）
- crypto：加密解密相关 （周边子系统）
- lib：内核通用库，给内核不同组件使用
- scripts：编译内核的脚本
- virt：虚拟化 （重要子系统）


#### linux内核系统体系结构

linux内核由 5 个模块构成：进程调度模块、内存管理模块、文件系统模块、进程间通信模块、网络接口模块。


- linux内核对内存的管理和使用
    - 同时采用分段和分页机制管理物理内存
    - 内存地址空间概念
        - 进程的虚拟和逻辑地址
        - CPU的线性地址
        - 实际物理内存地址
    - CPU 多任务和保护方式
    - 虚拟地址、线性地址、物理地址之间的关系
    - 用户申请内存的动态分配
- linux系统的中断机制
- linux的系统调用
    - 系统调用接口（syscall）
- 系统时间和定时
- linux进程控制
    - 任务数据结构（task_struct）
    - 进程运行状态
    - 进程初始化
    - 创建新进程（fork、exec）
    - 进程调度
    - 进程终止（exit、wait、waitpid）
- 内核系统与应用程序的关系
    - linux内核为用户程序提供两方面支持：系统调用接口、通过开发环境库函数或内核库函数与内核进行信息交流。

#### 流程

- PC电源打开后，BIOS执行系统检测，初始化中断向量。然后将可启动设备第一个扇区读入内存绝对地址0x7C00，并跳转到这个地方。0x7C00处为linux最前面执行的部分，也即使用汇编编写的boot部分。boot程序完成一系列初步的初始化工作后跳转到main。
- main进行内核系统初始化与环境初始化
- 内核通过执行调度函数（schedule）和时钟中断（_timer_interrupt）来调度进程。内核设定一个时钟中断速率，在该中断过程中，（调用do_timer）检查所有函数进程的当前执行情况来确定进程的下一步状态。