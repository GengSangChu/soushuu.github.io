---
layout:     post
title:      riscv
subtitle:   riscv
date:       2023-01-06
author:     soushuuu
header-img: img/the-first.png
catalog: false
tags:
    - riscv
---

CPU内部有三类核心部件：
1. ALU - 算术逻辑单元在 CPU 内执行所有计算
2. CU - 控制单元，协调数据移动方式，解码指令
3. RA - 寄存器寄存器阵列

软件编写后通过编译等操作转换为机器码，这些机器码就是CPU的指令，通过这些指令，CPU经过内部解码、计算等操作然后与外部IO设备、主存交互，如此，程序便运行了起来。

而这些指令，则被称为`ISA（Instruction Set Architecture）指令集体系架构`。ISA 描述了指令和操作如何由编译器编码，由处理器解码和执行，处理器架构中面向程序员的部分。

CPU ISA 被分类为精简指令集计算 (RISC) 和复杂指令集计算 (CISC)：
* RISC ISA 由简单的指令组成，支持少量简单操作（加、乘等）。所有指令的位长相同（例如 32 位），RISC 指令的硬件解码器认为是简单的；
* 相反，在 CISC ISA 中，不同的指令可以有不同的长度，单个指令就可以描述操作和条件的复杂组合。

RISC-V(读作“RISC-FIVE”)是基于精简指令集计算(RISC)原理建立的开放指令集架构(ISA)，V表示为第五代RISC(精简指令集计算机)


#### RISC-V 指令集

- RISC-V核心
    - 基础整数指令集（RV32I）
        - 寄存器
        - 整数计算
        - 取数和存数
        - 条件分支
        - 无条件跳转
- RISC-V标准扩展
    - 乘法和除法指令（RV32M）
    - 浮点指令（RV32F 和 RV32D）
        - 浮点寄存器
        - 浮点取数、存数和算术运算
        - 浮点转换和数据传送
    - 原子指令（RV32A）
        - 用于同步的原子操作
            - 原子内存操作
            - 预定取数/条件存数
- 压缩指令（RV32C）
- 向量指令（RV32V）
- 64位地址指令（RV64）
- 未来的可选扩展
    - 位操作
    - 嵌入式
    - 动态翻译语言
    - 十进制浮点
    - 紧缩 SIMD 指令
    - 四倍精度浮点
    - 用户态中断
    - 特权架构扩展：支持虚拟机管理器（Hypervisor）


#### RV32/64 特权架构

- 用户模式（user mode）（U模式）
- 监管模式（supervisor mode）（S模式）
    - 页式虚拟内存系统，将内存划分为固定大小的页以进行地址翻译和内存保护。
- 机器模式（machine mode）（M模式）
    - 物理内存保护（Physical Memory Protection，PMP），该功能允许M模式指令哪些物理内存可让U模式访问。

RISC-V提供3种特权模式，对指令进行不同的权限管理，以支持嵌入式系统和操作系统以及应用程序能够拥有对指令不同的权限。一般应用程序都运行在U模式；嵌入式系统能够直接操作硬件，运行在M模式；操作系统如Liunx则运行在S模式。


#### RISC-V 汇编

- 函数调用约定
- 汇编指令
- 汇编伪指令
    nop
    neg rd, rs
    negw rd, rs
    等等
- 汇编指示符
    .text 进入代码节
    .align 2 后续代码按2^2字节对齐
    .globl main 声明全局符号 “main”
    .section .rodata 进入只读数据节
    .balign 4 数据节按4字节对齐
    .string "Hello" 创建以空字符结尾的字符串
    等等

#### C语言翻译成计算机可执行的机器语言程序四个经典步骤

    C程序
    （编译器）->汇编程序
    （汇编器）->目标文件(机器语言模块)+库(机器语言模块)
    （链接器）->可执行文件(机器语言程序)
    （加载器）（加载可执行程序）

#### 小总结

我们编写的代码通过编译、汇编、链接、加载，进入内存，被操作系统调度，CPU执行我们程序的指令，这些指令一个一个接续执行，直到程序结束。

我们的程序通常有如下操作：
- 声明变量（栈中）
- 函数调用（指令跳转，执行完毕后跳回）
- 声明一个能够在各个地方使用的变量（堆中申请对象）
- 操作shell
- 文件操作（需要特权）
- 请求网络服务（需要特权）

这些指令操作大致可分为
- 计算——加减乘除、位操作
- 访存操作
- 访寄存器操作
- 跳转到某指令
- 中断
- JIT

拥有了汇编语言后，就可对计算机硬件进行操作，并且编写软件，编写操作系统来管理硬件，并提供接口，通过这些接口，又可编写操作系统之上的软件——应用软件。